<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="simulator">
<title>The Lasso with the Simulator • simulator</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The Lasso with the Simulator">
<meta property="og:description" content="simulator">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">simulator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/simulator.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/lasso.html">The Lasso with the Simulator</a>
    <a class="dropdown-item" href="../articles/james-stein.html">James-Stein with the Simulator</a>
    <a class="dropdown-item" href="../articles/elastic-net.html">The Elastic Net with the Simulator</a>
    <a class="dropdown-item" href="../articles/fdr.html">Benjamini-Hochberg with the Simulator</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jacobbien/simulator/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>The Lasso with the Simulator</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jacobbien/simulator/blob/HEAD/vignettes/lasso.Rmd" class="external-link"><code>vignettes/lasso.Rmd</code></a></small>
      <div class="d-none name"><code>lasso.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>In this vignette, we show how the simulator can be used to perform
simulations related to the <a href="https://rss.onlinelibrary.wiley.com/doi/10.1111/j.2517-6161.1996.tb02080.x" class="external-link">lasso</a>.</p>
</div>
<div class="section level2">
<h2 id="betting-on-sparsity">Betting on Sparsity<a class="anchor" aria-label="anchor" href="#betting-on-sparsity"></a>
</h2>
<p>In <a href="https://hastie.su.domains/ElemStatLearn/" class="external-link">The Elements of
Statistical Learning</a>, the authors describe a “bet on sparsity”
principle that suggests that one should,</p>
<blockquote>
<p>“Use a procedure that does well in sparse problems, since no
procedure does well in dense problems.”</p>
</blockquote>
<p>In support of this idea, they compare the performance of lasso and
ridge estimators in sparse and dense situations. We demonstrate how the
<code>simulator</code> can be used to perform such a simulation
study.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jacobbien/simulator" class="external-link">simulator</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_simulation.html">new_simulation</a></span><span class="op">(</span><span class="st">"bet-on-sparsity"</span>, <span class="st">"Bet on sparsity"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/generate_model.html">generate_model</a></span><span class="op">(</span><span class="va">make_sparse_linear_model</span>, n <span class="op">=</span> <span class="fl">200</span>, p <span class="op">=</span> <span class="fl">500</span>, snr <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                 k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">80</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 vary_along <span class="op">=</span> <span class="st">"k"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_from_model.html">simulate_from_model</a></span><span class="op">(</span>nsim <span class="op">=</span> <span class="fl">2</span>, index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/run_method.html">run_method</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lasso</span>, <span class="va">ridge</span><span class="op">)</span>,</span>
<span>             parallel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>socket_names <span class="op">=</span> <span class="fl">2</span>, libraries <span class="op">=</span> <span class="st">"glmnet"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sqrerr</span>, <span class="va">nnz</span>, <span class="va">df</span>, <span class="va">best_sqrerr</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Observe that the entire simulation is coded in less than 10 lines of
code.</p>
<ul>
<li><p>In the first line, we name the simulation (both in a
computer-friendly and human-readable way);</p></li>
<li><p>this newly created simulation is then piped<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The &lt;code&gt;simulator&lt;/code&gt; package imports the pipe
operator &lt;code&gt;%&amp;gt;%&lt;/code&gt; from the &lt;a href="https://github.com/tidyverse/magrittr" class="external-link"&gt;magrittr&lt;/a&gt; package. The
pipe passes the output of a function as the first argument of the next
function. This means that instead of writing
&lt;code&gt;sim &amp;lt;- simulate_from_model(sim, nsim = 2)&lt;/code&gt; followed by
&lt;code&gt;sim &amp;lt;- run_method(sim, my_method)&lt;/code&gt; followed by
&lt;code&gt;sim &amp;lt;- evaluate(sim, my_metric)&lt;/code&gt;, we can simply write
&lt;code&gt;sim &amp;lt;- sim %&amp;gt;% simulate_from_model(nsim = 2) %&amp;gt;% run_method(my_method) %&amp;gt;% evaluate(my_metric)&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a> to
<code>generate_model</code>, which creates a sequence of sparse linear
model objects where the sparsity level is varied from 5 to 80. These
model objects contain <span class="math inline">\(X\)</span> and <span class="math inline">\(\beta\)</span>, and a function describing how to
generate <span class="math inline">\(y\)</span>;</p></li>
<li><p>this is then piped to <code>simulate_from_model</code>, which
creates 4 draws (that is, <span class="math inline">\(y\)</span>
vectors) from each model (these are created in 2 chunks of size 2, each
getting its own random number generator stream so that we will get the
same results regardless of whether they are performed in parallel or in
sequence); <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;These numbers are small so that this vignette will be
fast for CRAN to check. But in practice, one might use, say, 4 chunks of
size 25 for a total of 100 random draws for each model.&lt;/p&gt;"><sup>2</sup></a></p></li>
<li><p>the simulation object is then piped to <code>run_method</code>,
where both the lasso and ridge are performed (in parallel, across 2
cpus) on all 64 instances (64=16*4; 16 models with 4 draws per
model);</p></li>
<li><p>finally, 4 metrics are computed on each method’s output across
all instances.</p></li>
</ul>
<p>All intermediate results are automatically saved to file, and the
simulation object <code>sim</code> contains references to all of these
saved results. The functions <code>model</code>, <code>draws</code>,
<code>output</code>, and <code>evals</code> can be applied to
<code>sim</code> to return various results created above. For now, we
are interested in looking at the final results of the simulation, which
are contained in <code>evals(sim)</code>.</p>
<p>The function <code>plot_eval_by</code> is designed for situations in
which we wish to see how a metric of interest varies with some model
parameter. In the “bet on sparsity” simulation, we might be curious to
see how varying the sparsity level of the model affects the
best-achievable mean squared error <span class="math inline">\(\min_\lambda\frac1{p}\|\hat\beta_\lambda-\beta\|^2\)</span>
of each method.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_eval_by.html">plot_eval_by</a></span><span class="op">(</span><span class="va">sim</span>, <span class="st">"best_sqrerr"</span>, varying <span class="op">=</span> <span class="st">"k"</span>, main <span class="op">=</span> <span class="st">"Betting on sparsity"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lasso_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>The rationale for the “bet on sparsity” principle is apparent from
this plot. When <span class="math inline">\(k\)</span> is low, we see
large gains in performance using the lasso compared to the ridge; when
<span class="math inline">\(k\)</span> is large, ridge does
better—however, in this regime, neither method is doing particularly
well (and in a relative sense, ridge’s advantage is only slight).</p>
<p>Rather than looking at just the best MSE of each method, we can also
examine how the MSE varies with degrees of freedom (which, unlike <span class="math inline">\(\lambda\)</span>, has the same meaning across
different methods). Let’s look in particular at two models with very
different sparsity levels <span class="math inline">\(k\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">sim</span>, <span class="va">k</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> <span class="fu"><a href="../reference/plot_evals.html">plot_evals</a></span><span class="op">(</span><span class="st">"df"</span>, <span class="st">"sqrerr"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lasso_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="the-relaxed-lasso">The relaxed lasso<a class="anchor" aria-label="anchor" href="#the-relaxed-lasso"></a>
</h2>
<p>Suppose we wish to add the <a href="http://stat.ethz.ch/~nicolai/relaxo.pdf" class="external-link">relaxed lasso</a> to this
comparison. The relaxed lasso involves fitting a lasso to determine the
set of nonzeros and then performing least squares on this selected
subset of variables.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim2</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span>methods <span class="op">=</span> <span class="st">"lasso"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"relaxing-the-lasso"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/relabel.html">relabel</a></span><span class="op">(</span><span class="st">"Effect of relaxing lasso"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/run_method.html">run_method</a></span><span class="op">(</span>methods <span class="op">=</span> <span class="va">lasso</span> <span class="op">+</span> <span class="va">refit</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sqrerr</span>, <span class="va">nnz</span>, <span class="va">df</span>, <span class="va">best_sqrerr</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will describe in a later section of this vignette how the
<code>simulator</code> interprets <code>lasso + refit</code> as an
extension of the <code>lasso</code> method and therefore does not
require re-running the lasso but instead takes the already saved output
from the lasso method and performs refitting on this output.</p>
<p>Let’s check if this is an improvement over the lasso.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_eval_by.html">plot_eval_by</a></span><span class="op">(</span><span class="va">sim2</span>, <span class="st">"best_sqrerr"</span>, varying <span class="op">=</span> <span class="st">"k"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lasso_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<p>It looks like the relaxed lasso does better only for small values of
<span class="math inline">\(k\)</span>. We can see this better by
looking at a table of the first several models with low true sparsity
level <span class="math inline">\(k\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim2</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span>methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lasso"</span>, <span class="st">"lasso_refit"</span><span class="op">)</span>, subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/tabulate_eval.html">tabulate_eval</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"best_sqrerr"</span>,</span>
<span>                format_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nsmall <span class="op">=</span> <span class="fl">3</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                output_type <span class="op">=</span> <span class="st">"markdown"</span><span class="op">)</span></span></code></pre></div>
<!-- generated by simulator on Wed Feb  1 22:16:27 2023. -->
<table class="table">
<caption>A comparison of Mean best squared error (averaged over 4
replicates).</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Lasso</th>
<th align="left">Lasso refitted</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">n = 200, p = 500, k = 5</td>
<td align="left">1e-03 (1e-04)</td>
<td align="left">9e-05 (2e-05)</td>
</tr>
<tr class="even">
<td align="left">n = 200, p = 500, k = 10</td>
<td align="left">4e-03 (5e-04)</td>
<td align="left">2e-03 (8e-04)</td>
</tr>
<tr class="odd">
<td align="left">n = 200, p = 500, k = 15</td>
<td align="left">8e-03 (7e-04)</td>
<td align="left">5e-03 (1e-03)</td>
</tr>
</tbody>
</table>
<p>As the true sparsity level increases, it makes sense that the
performance of the relaxed lasso degrades since the lasso can
accommodate a larger number of features whereas the relaxed lasso cannot
(since least squares suffers greatly when the number of features nears
the sample size <span class="math inline">\(n\)</span>). This
explanation is confirmed by plotting the MSE versus the number of
nonzeros in the fitted model:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">sim2</span>, methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lasso"</span>, <span class="st">"lasso_refit"</span><span class="op">)</span>, subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/plot_evals.html">plot_evals</a></span><span class="op">(</span><span class="st">"nnz"</span>, <span class="st">"sqrerr"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lasso_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<p>However, when the true sparsity level is larger, we see that the
relaxation can backfire.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">sim2</span>, methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lasso"</span>, <span class="st">"lasso_refit"</span><span class="op">)</span>, <span class="va">k</span> <span class="op">==</span> <span class="fl">40</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/plot_evals.html">plot_evals</a></span><span class="op">(</span><span class="st">"nnz"</span>, <span class="st">"sqrerr"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lasso_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>Since it looks like the relaxed lasso is not particularly beneficial
in this situation, let’s return to our comparison of the lasso and
ridge.</p>
</div>
<div class="section level2">
<h2 id="betting-on-sparsity-with-cross-validation">Betting on sparsity (with cross-validation)<a class="anchor" aria-label="anchor" href="#betting-on-sparsity-with-cross-validation"></a>
</h2>
<p>The simulation above side-stepped the issue of tuning parameter
selection by either looking at curves parameterized by <span class="math inline">\(\lambda\)</span> or by looking at the “best MSE”,
that is <span class="math inline">\(\min_\lambda MSE(\lambda)\)</span>.
In practice, it is common to use cross-validation to select the tuning
parameter, so it might be more practically relevant to compare the
performance of lasso and ridge when cross-validation is used to select
their tuning parameters.</p>
<p>Let’s create a new simulation object with the same model and
simulated data as before, but with two new methods:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim3</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span>methods <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"bet-on-sparsity-cv"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/relabel.html">relabel</a></span><span class="op">(</span><span class="st">"Bet on sparsity (with cross validation)"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/run_method.html">run_method</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lasso</span> <span class="op">+</span> <span class="va">cv</span>, <span class="va">ridge</span> <span class="op">+</span> <span class="va">cv</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sqrerr</span>, <span class="va">nnz</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_eval_by.html">plot_eval_by</a></span><span class="op">(</span><span class="va">sim3</span>, <span class="st">"sqrerr"</span>, varying <span class="op">=</span> <span class="st">"k"</span>, main <span class="op">=</span> <span class="st">"Betting on sparsity"</span><span class="op">)</span></span></code></pre></div>
<p><img src="lasso_files/figure-html/unnamed-chunk-16-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="a-look-at-the-components-of-the-simulations-above">A look at the components of the simulations above<a class="anchor" aria-label="anchor" href="#a-look-at-the-components-of-the-simulations-above"></a>
</h2>
<p>The idea of the <code>simulator</code> is that one should only have
to write problem-specific code when performing simulations. Everything
else—bookkeeping, saving/loading results, parallelization, handling of
random number generator streams, plotting, making tables—is taken care
of by the <code>simulator</code>. We look now at the problem-specific
components that were “plugged in” to the simulator to perform the
simulations above. The components of the <code>simulator</code> are
organized into models, methods, and metrics, as demonstrated below.
Although not required, to stay organized we recommend having each of
these components defined in separate files, named
<code>model_functions.R</code>, <code>method_functions.R</code>, and
<code>eval_functions.R</code>.</p>
<div class="section level3">
<h3 id="the-model">The model<a class="anchor" aria-label="anchor" href="#the-model"></a>
</h3>
<p>We simulate from a linear model <span class="math display">\[
Y=X\beta + \epsilon
\]</span> where <span class="math inline">\(Y\in\mathbb R^n\)</span>,
<span class="math inline">\(\beta\in\mathbb R^p\)</span>, and <span class="math inline">\(\epsilon\sim N(0,\sigma^2I_n)\)</span>. We have
taken <span class="math inline">\(X\)</span> to have iid <span class="math inline">\(N(0,1)\)</span> entries and treat it as fixed in
this simulation. We define a <code>Model</code> object, which specifies
the parameters and, most importantly, describes how to simulate
data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_sparse_linear_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">p</span>, <span class="va">k</span>, <span class="va">snr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">p</span> <span class="op">-</span> <span class="va">k</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mu</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">snr</span><span class="op">)</span><span class="op">)</span> <span class="co"># taking snr = ||mu||^2 / (n * sigma^2)</span></span>
<span>  <span class="fu"><a href="../reference/new_model.html">new_model</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"slm"</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"n = %s, p = %s, k = %s"</span>, <span class="va">n</span>, <span class="va">p</span>, <span class="va">k</span><span class="op">)</span>,</span>
<span>            params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, beta <span class="op">=</span> <span class="va">beta</span>, mu <span class="op">=</span> <span class="va">mu</span>, sigma <span class="op">=</span> <span class="va">sigma</span>, n <span class="op">=</span> <span class="va">n</span>,</span>
<span>                          p <span class="op">=</span> <span class="va">p</span>, k <span class="op">=</span> <span class="va">k</span><span class="op">)</span>,</span>
<span>            simulate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span>, <span class="va">nsim</span><span class="op">)</span> <span class="op">{</span></span>
<span>              <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nsim</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">mu</span> <span class="op">+</span> <span class="va">sigma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will typically put the code above in a file named
<code>model_functions.R</code>.</p>
</div>
<div class="section level3">
<h3 id="the-methods">The methods<a class="anchor" aria-label="anchor" href="#the-methods"></a>
</h3>
<p>We compare the lasso and ridge. Both of these methods depend on
tuning parameters, so we compute a sequence of solutions.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu" class="external-link">glmnet</a></span><span class="op">)</span></span>
<span><span class="va">lasso</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_method.html">new_method</a></span><span class="op">(</span><span class="st">"lasso"</span>, <span class="st">"Lasso"</span>,</span>
<span>                    method <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">draw</span>, <span class="va">lambda</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>                      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span></span>
<span>                        <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html" class="external-link">glmnet</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">draw</span>, nlambda <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                      intercept <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>                      <span class="kw">else</span> <span class="op">{</span></span>
<span>                        <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html" class="external-link">glmnet</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">draw</span>, lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>                                      intercept <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>                      <span class="op">}</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">beta</span>, yhat <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">fit</span><span class="op">$</span><span class="va">beta</span>,</span>
<span>                           lambda <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">lambda</span>, df <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">df</span><span class="op">)</span></span>
<span>                    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ridge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_method.html">new_method</a></span><span class="op">(</span><span class="st">"ridge"</span>, <span class="st">"Ridge"</span>,</span>
<span>                    method <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">draw</span>, <span class="va">lambda</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>                      <span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>                      <span class="va">df_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lam</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="co"># degrees of freedom when tuning param is lam</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sv</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="op">(</span><span class="va">sv</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">lam</span><span class="op">)</span><span class="op">)</span></span>
<span>                      <span class="op">}</span></span>
<span>                      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">nlambda</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span>                        <span class="va">get_lam</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>                          <span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lam</span><span class="op">)</span> <span class="fu">df_fun</span><span class="op">(</span><span class="va">lam</span><span class="op">)</span> <span class="op">-</span> <span class="va">target_df</span></span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">f</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sv</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">root</span></span>
<span>                        <span class="op">}</span></span>
<span>                        <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                                             length <span class="op">=</span> <span class="va">nlambda</span><span class="op">)</span>, <span class="va">get_lam</span><span class="op">)</span></span>
<span>                      <span class="op">}</span></span>
<span>                      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">lambda</span>, <span class="va">df_fun</span><span class="op">)</span></span>
<span>                      <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">lambda</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">sv</span><span class="op">$</span><span class="va">d</span> <span class="op">/</span> <span class="op">(</span><span class="va">sv</span><span class="op">$</span><span class="va">d</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">r</span><span class="op">)</span></span>
<span>                        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sv</span><span class="op">$</span><span class="va">v</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="op">(</span><span class="va">d</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">sv</span><span class="op">$</span><span class="va">u</span>, <span class="va">draw</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                      <span class="op">}</span><span class="op">)</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, yhat <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span>,</span>
<span>                           lambda <span class="op">=</span> <span class="va">lambda</span>, df <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span>                    <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Methods can return different items. However, aspects of the method
that will be used downstream in the simulation and compared across
methods should be in a common format. Thus <code>beta</code>,
<code>yhat</code>, and <code>df</code> in each case are in the same
format. These will be the items used when evaluating the methods’
performances.</p>
<p>We will typically put the code above in a file named
<code>method_functions.R</code>.</p>
</div>
<div class="section level3">
<h3 id="the-metrics">The metrics<a class="anchor" aria-label="anchor" href="#the-metrics"></a>
</h3>
<p>When we compare methods in plots and tables, there are usually a
number of “metrics” we use. An object of class <code>Metric</code>
specifies how to go from a model’s parameters and the output of a method
and return some quantity of interest.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sqrerr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_metric.html">new_metric</a></span><span class="op">(</span><span class="st">"sqrerr"</span>, <span class="st">"squared error"</span>,</span>
<span>                  metric <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">out</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">beta</span> <span class="op">-</span> <span class="va">model</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>                  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_sqrerr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_metric.html">new_metric</a></span><span class="op">(</span><span class="st">"best_sqrerr"</span>, <span class="st">"best squared error"</span>,</span>
<span>                      metric <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">out</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">beta</span> <span class="op">-</span> <span class="va">model</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>                      <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nnz</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_metric.html">new_metric</a></span><span class="op">(</span><span class="st">"nnz"</span>, <span class="st">"number of nonzeros"</span>,</span>
<span>                  metric <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">out</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>                  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_metric.html">new_metric</a></span><span class="op">(</span><span class="st">"df"</span>, <span class="st">"degrees of freedom"</span>,</span>
<span>                 metric <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">out</span><span class="op">)</span> <span class="va">out</span><span class="op">$</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p>Observe that <code>out</code> refers to the list returned by our
methods and <code>model</code> refers to the <code>Model</code> object
that is generated by <code>make_sparse_linear_model</code>. The
<code>$</code> operator can be used to get parameters that are stored in
the <code>Model</code> object.</p>
<p>We will typically put the code above in a file named
<code>eval_functions.R</code>.</p>
</div>
<div class="section level3">
<h3 id="extensions-of-the-methods">Extensions of the methods<a class="anchor" aria-label="anchor" href="#extensions-of-the-methods"></a>
</h3>
<p>In the simulations above, we saw two examples in which we studied
methods that were extended versions of other methods. While the relaxed
lasso could have been treated as a completely separate method from the
lasso, this would have been wasteful in a comparison to the lasso since
it would have required us to fit the lasso twice (once when calling the
lasso and once within the relaxed lasso). Instead, we created what is
called an <code>ExtendedMethod</code> object, which behaves like a
<code>Method</code> object, except it allows one to use the output of
another method.</p>
<p>If we only care about relaxing the lasso, we might directly create an
<code>ExtendedMethod</code>. However, in some situations, we may wish to
extend multiple methods in the same fashion. For example, perhaps we may
later wish to “relax” both the lasso and another variable selection
procedure, such as SCAD or MCP. In the spirit of code reusability, we
therefore created a <code>MethodExtension</code> object called
<code>refit</code>. A <code>MethodExtension</code> object when added to
a <code>Method</code> object generates an <code>ExtendedMethod</code>.
In our example of the relaxed lasso, we created a
<code>MethodExtension</code> called <code>refit</code> that takes any
method’s output and performs least squares on the nonzeros.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">refit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_method_extension.html">new_method_extension</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"refit"</span>, label <span class="op">=</span> <span class="st">"refitted"</span>,</span>
<span>                              method_extension <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">draw</span>, <span class="va">out</span>,</span>
<span>                                                          <span class="va">base_method</span><span class="op">)</span> <span class="op">{</span></span>
<span>                                <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">beta</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">{</span></span>
<span>                                  <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">b</span> <span class="op">!=</span> <span class="fl">0</span></span>
<span>                                  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>                                    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span>                                  <span class="va">xtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span><span class="op">)</span></span>
<span>                                  <span class="co"># add small ridge in case solution has more</span></span>
<span>                                  <span class="co"># than n nonzeros:</span></span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">xtx</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">xtx</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1e-4</span></span>
<span>                                  <span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">xtx</span>,</span>
<span>                                              <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="va">ii</span><span class="op">]</span>, <span class="va">draw</span><span class="op">)</span><span class="op">)</span></span>
<span>                                  <span class="va">b</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bb</span></span>
<span>                                  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span>                                <span class="op">}</span><span class="op">)</span></span>
<span>                                <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>,</span>
<span>                                            yhat <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span>,</span>
<span>                                            lambda <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">lambda</span>,</span>
<span>                                            df <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                              <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Having created the <code>MethodExtension</code>, we can get the
relaxed lasso <code>ExtendedMethod</code> through the simple addition of
objects:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lasso</span> <span class="op">+</span> <span class="va">refit</span></span></code></pre></div>
<pre><code><span><span class="co">## ExtendedMethod Component</span></span>
<span><span class="co">##  name: lasso_refit</span></span>
<span><span class="co">##  label: Lasso refitted</span></span></code></pre>
<p>If we had defined a different variable selection procedure, say
<code>mcp</code>, we could just as easily generated its relaxed version,
writing no new code:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">relaxed_mcp</span> <span class="op">&lt;-</span> <span class="va">mcp</span> <span class="op">+</span> <span class="va">refit</span></span></code></pre></div>
<p>The other example of a method extension in the simulations above was
cross-validation. We wrote this method extension so that it could be
used to create extended versions of multiple methods.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Make folds for cross validation</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Divides the indices \code{1:n} into \code{nfolds} random folds of about the same size.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param n sample size</span></span>
<span><span class="co">#' @param nfolds number of folds</span></span>
<span><span class="va">make_folds</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">nfolds</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">n</span> <span class="op">/</span> <span class="va">nfolds</span><span class="op">)</span></span>
<span>  <span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">nn</span>, <span class="va">nfolds</span><span class="op">)</span></span>
<span>  <span class="va">sizes</span><span class="op">[</span><span class="va">nfolds</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sizes</span><span class="op">[</span><span class="va">nfolds</span><span class="op">]</span> <span class="op">+</span> <span class="va">n</span> <span class="op">-</span> <span class="va">nn</span> <span class="op">*</span> <span class="va">nfolds</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">nfolds</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">folds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ii</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">b</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">b</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">folds</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_method_extension.html">new_method_extension</a></span><span class="op">(</span><span class="st">"cv"</span>, <span class="st">"cross validated"</span>,</span>
<span>                           method_extension <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">draw</span>, <span class="va">out</span>,</span>
<span>                                                       <span class="va">base_method</span><span class="op">)</span> <span class="op">{</span></span>
<span>                             <span class="va">nfolds</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span>                             <span class="va">err</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>, <span class="va">nfolds</span><span class="op">)</span></span>
<span>                             <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu">make_folds</span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">n</span>, <span class="va">nfolds</span><span class="op">)</span></span>
<span>                             <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>                               <span class="va">train</span> <span class="op">&lt;-</span> <span class="va">model</span></span>
<span>                               <span class="va">train</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">ii</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="op">]</span></span>
<span>                               <span class="va">train</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">train</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>                               <span class="va">train_draw</span> <span class="op">&lt;-</span> <span class="va">draw</span><span class="op">[</span><span class="op">-</span><span class="va">ii</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>                               <span class="va">test</span> <span class="op">&lt;-</span> <span class="va">model</span></span>
<span>                               <span class="va">test</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">ii</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="op">]</span></span>
<span>                               <span class="va">test</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">test</span><span class="op">@</span><span class="va">params</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>                               <span class="va">test_draw</span> <span class="op">&lt;-</span> <span class="va">draw</span><span class="op">[</span><span class="va">ii</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>                               <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">base_method</span><span class="op">@</span><span class="va">method</span><span class="op">(</span>model <span class="op">=</span> <span class="va">train</span>,</span>
<span>                                                         draw <span class="op">=</span> <span class="va">train_draw</span>,</span>
<span>                                                         lambda <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span></span>
<span>                               <span class="va">yhat</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">fit</span><span class="op">$</span><span class="va">beta</span></span>
<span>                               <span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">yhat</span><span class="op">)</span><span class="op">)</span></span>
<span>                               <span class="va">err</span><span class="op">[</span><span class="va">ll</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="op">(</span><span class="va">yhat</span> <span class="op">-</span> <span class="va">test_draw</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>                             <span class="op">}</span></span>
<span>                             <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span></span>
<span>                             <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">err</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">nfolds</span><span class="op">)</span></span>
<span>                             <span class="va">imin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span>                             <span class="va">ioneserule</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">m</span> <span class="op">&lt;=</span> <span class="va">m</span><span class="op">[</span><span class="va">imin</span><span class="op">]</span> <span class="op">+</span> <span class="va">se</span><span class="op">[</span><span class="va">imin</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>err <span class="op">=</span> <span class="va">err</span>, m <span class="op">=</span> <span class="va">m</span>, se <span class="op">=</span> <span class="va">se</span>, imin <span class="op">=</span> <span class="va">imin</span>,</span>
<span>                                  ioneserule <span class="op">=</span> <span class="va">ioneserule</span>,</span>
<span>                                  beta <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>, <span class="va">imin</span><span class="op">]</span>,</span>
<span>                                  yhat <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">out</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>, <span class="va">imin</span><span class="op">]</span><span class="op">)</span></span>
<span>                           <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We will typically put the code above in the file named
<code>method_functions.R</code>, though if that file is large, we may
prefer to have a separate file named, perhaps,
<code>method_extensions_functions.R</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette demonstrated some features of the
<code>simulator</code> such as parallel computing, writing extensions to
methods, and making basic plots and tables. In other vignettes,
additional features are demonstrated. For example, the vignette on the
elastic net demonstrates how one can work with a sequence of methods
that are identical except for a particular setting (such as <span class="math inline">\(\alpha\)</span> for the elastic net).</p>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jacob Bien.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
