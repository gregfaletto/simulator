<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="simulator">
<title>Benjamini-Hochberg Procedure with the Simulator • simulator</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Benjamini-Hochberg Procedure with the Simulator">
<meta property="og:description" content="simulator">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">simulator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/simulator.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples">Examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples">
    <a class="dropdown-item" href="../articles/lasso.html">The Lasso with the Simulator</a>
    <a class="dropdown-item" href="../articles/james-stein.html">James-Stein with the Simulator</a>
    <a class="dropdown-item" href="../articles/elastic-net.html">The Elastic Net with the Simulator</a>
    <a class="dropdown-item" href="../articles/fdr.html">Benjamini-Hochberg with the Simulator</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jacobbien/simulator/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Benjamini-Hochberg Procedure with the Simulator</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jacobbien/simulator/blob/HEAD/vignettes/fdr.Rmd" class="external-link"><code>vignettes/fdr.Rmd</code></a></small>
      <div class="d-none name"><code>fdr.Rmd</code></div>
    </div>

    
    
<p>Suppose we wish to test <span class="math inline">\(n\)</span>
hypotheses, <span class="math inline">\(H_1,\ldots, H_n\)</span>, and we
have a p-value <span class="math inline">\(\hat p_i\)</span> for each
hypothesis <span class="math inline">\(H_i\)</span>. That is,</p>
<p><span class="math display">\[
\mathbb{P}_{H_i}(\hat p_i\le \alpha) = \alpha.
\]</span></p>
<p><a href="http://www.jstor.org/stable/2346101" class="external-link">Benjamini and Hochberg
(1995)</a> design a procedure (for when these p-values are independent)
that controls what they call the <em>false discovery rate</em> (FDR),
which is the expected proportion of the rejected tests that should not
have been rejected:</p>
<p><span class="math display">\[
\mathbb{E}_{\{H_i:i\in S\}}\left[\frac{\sum_{i\in S}1\{H_i\text{
rejected}\}}{\max[1,\sum_{i=1}^n1\{H_i\text{ rejected}\}]}\right].
\]</span></p>
<p>Given a desired FDR <span class="math inline">\(q\)</span>, the BH
procedure finds a data-adaptive threshold level <span class="math inline">\(\hat p(q)\)</span> and rejects all <span class="math inline">\(H_i\)</span> for which <span class="math inline">\(\hat p_i\le \hat p(q)\)</span>. The threshold
level is given by comparing the sorted p-values <span class="math inline">\(\hat p_{(1)}\le \cdots \le \hat p_{(n)}\)</span>
to a line of slope <span class="math inline">\(q/n\)</span> and
identifying the largest p-value that is below this line. That is, <span class="math inline">\(\hat p(q)=\hat p_{(\hat i)}\)</span> where <span class="math display">\[
\hat i = \max\{i: \hat p_i \le q i / n\}.
\]</span></p>
<p>In this simulation, we verify that the BH procedure works, and we
investigate the effect that correlation has on the FDR control.</p>
<div class="section level2">
<h2 id="main-simulation">Main simulation<a class="anchor" aria-label="anchor" href="#main-simulation"></a>
</h2>
<p>In the Models section below, we show the code for
<code>make_correlated_pvalues</code>, a function that generates a model
object given parameters <span class="math inline">\(n\)</span> (the
number of hypotheses), <span class="math inline">\(\pi_0\)</span> (the
fraction of hypotheses that are null), and <span class="math inline">\(\rho\)</span> (the correlation between any pair of
test statistics). In the simulation below, we fix <span class="math inline">\(n=20\)</span> and vary <span class="math inline">\(\pi_0\)</span> and <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jacobbien/simulator" class="external-link">simulator</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">name_of_simulation</span> <span class="op">&lt;-</span> <span class="st">"fdr"</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_simulation.html">new_simulation</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name_of_simulation</span>,</span>
<span>                      label <span class="op">=</span> <span class="st">"False Discovery Rate"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/generate_model.html">generate_model</a></span><span class="op">(</span><span class="va">make_correlated_pvalues</span>, seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>                 n <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                 pi0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                 rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>                 vary_along <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pi0"</span>, <span class="st">"rho"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_from_model.html">simulate_from_model</a></span><span class="op">(</span>nsim <span class="op">=</span> <span class="fl">25</span>, index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/run_method.html">run_method</a></span><span class="op">(</span><span class="va">bh_methods</span>, parallel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>socket_names <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fdp</span>, <span class="va">nd</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The variable <code>bh_methods</code> is defined in the Methods
section below and corresponds to the BH procedure for four different
values of <span class="math inline">\(q\)</span>.</p>
<p>We begin by looking at the results when <span class="math inline">\(\rho=0\)</span> (i.e., independent tests).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tabulate_eval.html">tabulate_eval</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"fdp"</span>, output_type <span class="op">=</span> <span class="st">"html"</span>, </span>
<span>                format_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span>, nsmall <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- generated by simulator on Wed Feb  1 19:13:52 2023. -->
<table class="table">
<caption>
A comparison of Mean false discovery proportion (averaged over 100
replicates).
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
BH (q = 0.05)
</th>
<th style="text-align:left;">
BH (q = 0.1)
</th>
<th style="text-align:left;">
BH (q = 0.2)
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
pi0 = 0.8, rho = 0
</td>
<td style="text-align:left;">
0.04 (0.01)
</td>
<td style="text-align:left;">
0.08 (0.02)
</td>
<td style="text-align:left;">
0.17 (0.02)
</td>
</tr>
<tr>
<td style="text-align:left;">
pi0 = 1, rho = 0
</td>
<td style="text-align:left;">
0.04 (0.02)
</td>
<td style="text-align:left;">
0.08 (0.03)
</td>
<td style="text-align:left;">
0.25 (0.04)
</td>
</tr>
</tbody>
</table>
<p>It appears that the BH procedure does control the FDR at each stated
<span class="math inline">\(q\)</span> value. However, we also see that
when <span class="math inline">\(\pi_0\)</span> is less than 1, it tends
to be more conservative. Indeed, Benjamini and Hochberg show that the
FDR of BH does not exceed <span class="math inline">\(\pi_0q\)</span>.</p>
</div>
<div class="section level2">
<h2 id="adding-to-a-simulation">Adding to a simulation<a class="anchor" aria-label="anchor" href="#adding-to-a-simulation"></a>
</h2>
<p>We might like to increase the number of simulations.</p>
<p>Suppose we return to this simulation several days later and wish to
double the number of random draws used. In the above code, we had 100
draws, which were simulated in 4 chunks of 25 draws each. The simulator
allows us to add to a simulation without requiring us to re-run parts of
the simulation that have already been run.</p>
<p>If we had closed the R session without saving the image[^]: for the
sake of reproducibility, I like to always start with a fresh workspace,
so I can be sure that my functions aren’t calling a global variable that
I have forgotten about), we can open a new one in the directory that has
the <code>files</code> directory in it. We start by loading
<code>sim</code>, which is the Simulation object (containing all the
necessary pointers to saved files). Loading <code>sim</code> is fast
because it only loads the file locations, not the files themselves.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_simulation.html">load_simulation</a></span><span class="op">(</span><span class="st">"fdr"</span><span class="op">)</span></span></code></pre></div>
<p>We do so by simply adding 4 more chunks, with <code>index=5:8</code>.
Each distinct value of <code>index</code> corresponds to a separate <a href="http://www.iro.umontreal.ca/~lecuyer/myftp/papers/streams00.pdf" class="external-link">random
number generator stream</a>. This is convenient because it means that we
do not have to rely on the state of the RNG after completing one chunk
to start the next one.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_from_model.html">simulate_from_model</a></span><span class="op">(</span>nsim <span class="op">=</span> <span class="fl">25</span>, index <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/run_method.html">run_method</a></span><span class="op">(</span><span class="va">bh_methods</span>, parallel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>socket_names <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fdp</span>, <span class="va">nd</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can look again at the table.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/tabulate_eval.html">tabulate_eval</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"fdp"</span>, output_type <span class="op">=</span> <span class="st">"html"</span>, </span>
<span>                format_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span>, nsmall <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- generated by simulator on Wed Feb  1 19:13:53 2023. -->
<table class="table">
<caption>
A comparison of Mean false discovery proportion (averaged over 200
replicates).
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
BH (q = 0.05)
</th>
<th style="text-align:left;">
BH (q = 0.1)
</th>
<th style="text-align:left;">
BH (q = 0.2)
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
pi0 = 0.8, rho = 0
</td>
<td style="text-align:left;">
0.03 (0.009)
</td>
<td style="text-align:left;">
0.07 (0.010)
</td>
<td style="text-align:left;">
0.15 (0.014)
</td>
</tr>
<tr>
<td style="text-align:left;">
pi0 = 1, rho = 0
</td>
<td style="text-align:left;">
0.03 (0.013)
</td>
<td style="text-align:left;">
0.07 (0.018)
</td>
<td style="text-align:left;">
0.19 (0.028)
</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="some-plots">Some plots<a class="anchor" aria-label="anchor" href="#some-plots"></a>
</h3>
<p>The FDR is the average of the false discovery proportion (FDP). We
can look at these raw values (200 for each method-model pair).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span><span class="fu"><a href="../reference/plot_eval.html">plot_eval</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"fdp"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fdr_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
<p>When <span class="math inline">\(\pi_0=1\)</span>, we see that the
FDP is either 0 or 1. This is because if we make any number of
discoveries, then they will all be false (but if we do not make any
discoveries, we have FDP=0).</p>
<p>We now investigate the effect of <span class="math inline">\(\rho\)</span>, the correlation between the test
statistics. We now fix <span class="math inline">\(\pi_0=0.8\)</span>
and look at how the plots vary with <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">pi0</span> <span class="op">==</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span><span class="fu"><a href="../reference/plot_eval.html">plot_eval</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"fdp"</span>, varying <span class="op">=</span> <span class="st">"rho"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fdr_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
<p>Since <span class="math inline">\(\rho\)</span> is numeric, it might
be more informative to look at the FDR as a function of <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">pi0</span> <span class="op">==</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span><span class="fu"><a href="../reference/plot_eval_by.html">plot_eval_by</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"fdp"</span>, varying <span class="op">=</span> <span class="st">"rho"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fdr_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>We see that the procedure becomes more conservative as the dependence
increases, but still does control FDR (which was shown for positive
dependence in <a href="https://projecteuclid.org/euclid.aos/1013699998" class="external-link">Benjamini and
Yekutieli, 2001</a>). Looking at <span class="math inline">\(\pi_0=1\)</span>, we would like to check whether
for negative <span class="math inline">\(\rho\)</span> the procedure is
anti-conservative.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">pi0</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> </span>
<span><span class="fu"><a href="../reference/plot_eval_by.html">plot_eval_by</a></span><span class="op">(</span>metric_name <span class="op">=</span> <span class="st">"fdp"</span>, varying <span class="op">=</span> <span class="st">"rho"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fdr_files/figure-html/unnamed-chunk-13-1.png" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-simulation-based-on-a-preexisting-one">Creating a simulation based on a preexisting one<a class="anchor" aria-label="anchor" href="#creating-a-simulation-based-on-a-preexisting-one"></a>
</h2>
<p>To investigate this particular question in greater depth, we might
create a new simulation object based on the previous one. We’d like to
increase the number of random draws for this particular setting, but
don’t care about doing so for the others.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subset_simulation.html">subset_simulation</a></span><span class="op">(</span><span class="va">sim</span>, <span class="va">pi0</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">rho</span> <span class="op">==</span> <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"fdr-negdep"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/relabel.html">relabel</a></span><span class="op">(</span><span class="st">"BH Procedure under negative dependence"</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/simulate_from_model.html">simulate_from_model</a></span><span class="op">(</span>nsim <span class="op">=</span> <span class="fl">25</span>, index <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/run_method.html">run_method</a></span><span class="op">(</span><span class="va">bh_methods</span>, parallel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>socket_names <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/evaluate.html">evaluate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fdp</span>, <span class="va">nd</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We remake the table (on the basis of 500 random draws) to check for
anti-conservativeness.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tabulate_eval.html">tabulate_eval</a></span><span class="op">(</span><span class="va">sim2</span>, metric_name <span class="op">=</span> <span class="st">"fdp"</span>, output_type <span class="op">=</span> <span class="st">"html"</span>, </span>
<span>                format_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span>, nsmall <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- generated by simulator on Wed Feb  1 19:13:56 2023. -->
<table class="table">
<caption>
A comparison of Mean false discovery proportion (averaged over 500
replicates).
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
BH (q = 0.05)
</th>
<th style="text-align:left;">
BH (q = 0.1)
</th>
<th style="text-align:left;">
BH (q = 0.2)
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
pi0 = 1, rho = -0.01
</td>
<td style="text-align:left;">
0.04 (0.009)
</td>
<td style="text-align:left;">
0.08 (0.012)
</td>
<td style="text-align:left;">
0.21 (0.018)
</td>
</tr></tbody>
</table>
<p>Observe that at this point, <code>sim</code> and <code>sim2</code>
are two separate simulation objects that refer to some common simulation
results. For example, their <code>Model</code> and <code>Draws</code>
objects are the same.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">sim</span>, <span class="va">pi0</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">rho</span> <span class="op">==</span> <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">sim2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">m2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/draws.html">draws</a></span><span class="op">(</span><span class="va">sim</span>, <span class="va">pi0</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">rho</span> <span class="op">==</span> <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">d2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/draws.html">draws</a></span><span class="op">(</span><span class="va">sim2</span>, index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">d2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>When <code>model</code> and <code>draws</code> (and likewise
<code>output</code> and <code>evals</code>) are called on a simulation
object, they load the appropriate files referenced by the
<code>Simulation</code> object. The models <code>m</code> and
<code>m2</code> are identical (and likewise for <code>d</code> and
<code>d2</code>) because both <code>Simulation</code> objects refer to
the same saved files. Thus, having multiple simulation objects does not
lead to copies of the (potentially large) results files being made.
Instead, only the references themselves are duplicated.</p>
</div>
<div class="section level2">
<h2 id="components">Components<a class="anchor" aria-label="anchor" href="#components"></a>
</h2>
<div class="section level3">
<h3 id="models">Models<a class="anchor" aria-label="anchor" href="#models"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span>
<span><span class="va">make_correlated_pvalues</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">pi0</span>, <span class="va">rho</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Gaussian copula model...</span></span>
<span>  <span class="co">#</span></span>
<span>  <span class="co"># n pvalues, the first n*pi0 of which are null, coming from a multivariate</span></span>
<span>  <span class="co"># normal with all correlations rho.</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">rho</span>, <span class="va">n</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">n0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">pi0</span><span class="op">)</span></span>
<span>  <span class="va">delta</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># size of signal</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">delta</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n0</span>, <span class="va">n</span> <span class="op">-</span> <span class="va">n0</span><span class="op">)</span><span class="op">)</span> <span class="co"># n0 are null</span></span>
<span>  <span class="fu"><a href="../reference/new_model.html">new_model</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"correlated-pvalues"</span>,</span>
<span>            label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"pi0 = %s, rho = %s"</span>, <span class="va">pi0</span>, <span class="va">rho</span><span class="op">)</span>,</span>
<span>            params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, rho <span class="op">=</span> <span class="va">rho</span>, sigma <span class="op">=</span> <span class="va">sigma</span>,</span>
<span>                          pi0 <span class="op">=</span> <span class="va">pi0</span>, mu <span class="op">=</span> <span class="va">mu</span>, delta <span class="op">=</span> <span class="va">delta</span>,</span>
<span>                          nonnull <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            simulate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">sigma</span>, <span class="va">nsim</span><span class="op">)</span> <span class="op">{</span></span>
<span>              <span class="co"># this function must return a list of length nsim</span></span>
<span>              <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">nsim</span>, mean <span class="op">=</span> <span class="va">mu</span>, sigma <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span>              <span class="va">pvals</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>              <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">pvals</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.html" class="external-link">row</a></span><span class="op">(</span><span class="va">pvals</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># make each row its own list element</span></span>
<span>            <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_bh</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">q</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># q is the desired level of control for the FDR</span></span>
<span>  <span class="fu"><a href="../reference/new_method.html">new_method</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bh"</span>, <span class="va">q</span><span class="op">)</span>,</span>
<span>             label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"BH (q = %s)"</span>, <span class="va">q</span><span class="op">)</span>,</span>
<span>             settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="va">q</span><span class="op">)</span>,</span>
<span>             method <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">draw</span>, <span class="va">q</span><span class="op">)</span> <span class="op">{</span></span>
<span>               <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">draw</span><span class="op">)</span></span>
<span>               <span class="va">cutline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">n</span><span class="op">)</span> <span class="op">*</span> <span class="va">q</span> <span class="op">/</span> <span class="va">model</span><span class="op">$</span><span class="va">n</span></span>
<span>               <span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="va">p</span> <span class="op">&lt;=</span> <span class="va">cutline</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rejected <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">draw</span> <span class="op">&lt;=</span> <span class="va">threshold</span><span class="op">)</span><span class="op">)</span></span>
<span>             <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">qvalues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">bh_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">qvalues</span>, <span class="va">make_bh</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="metrics">Metrics<a class="anchor" aria-label="anchor" href="#metrics"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_metric.html">new_metric</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"fdp"</span>,</span>
<span>                  label <span class="op">=</span> <span class="st">"false discovery proportion"</span>,</span>
<span>                  metric <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">out</span><span class="op">)</span> <span class="op">{</span></span>
<span>                    <span class="va">fp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">rejected</span>, <span class="va">model</span><span class="op">$</span><span class="va">nonnull</span><span class="op">)</span></span>
<span>                    <span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">rejected</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>                    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fp</span><span class="op">)</span> <span class="op">/</span> <span class="va">nd</span><span class="op">)</span></span>
<span>                    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_metric.html">new_metric</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"nd"</span>,</span>
<span>                 label <span class="op">=</span> <span class="st">"number of discoveries"</span>,</span>
<span>                 metric <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">out</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">rejected</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>To cite the <code>simulator</code>, please use</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"simulator"</span><span class="op">)</span></span></code></pre></div>
<p>To cite package ‘simulator’ in publications use:</p>
<p>Bien J (2016). “The simulator: An Engine to Streamline Simulations.”
<em>Submitted</em>. <a href="http://arxiv.org/abs/1607.00021" class="external-link uri">http://arxiv.org/abs/1607.00021</a>.</p>
<p>A BibTeX entry for LaTeX users is</p>
<p><span class="citation">@Article</span>{, title = {The {simulator}: An
Engine to Streamline Simulations}, author = {Jacob Bien}, year = {2016},
url = {<a href="http://arxiv.org/abs/1607.00021" class="external-link uri">http://arxiv.org/abs/1607.00021</a>}, journal = {Submitted},
}</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jacob Bien.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
